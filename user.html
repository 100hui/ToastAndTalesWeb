<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Profile - Toast & Tales</title>
    <link rel="stylesheet" href="homepage.css">
    <style>
        /* Extra styles just for the badges */
        .badges-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .badge-card {
            background: white;
            border: 2px solid var(--yakun-brown); /* Using your brown var */
            border-radius: 10px;
            padding: 20px;
            width: 200px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .badge-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .badge-title {
            color: var(--yakun-red);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-desc {
            font-size: 0.8rem;
            color: #666;
        }

        .locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">Toast & Tales</div>
        <div class="nav-links">
            <a href="index.html" class="nav-btn">Home</a>
        </div>
    </nav>

    <main style="max-width:800px;margin:40px auto;padding:20px;">
        <h2>Your Profile</h2>
        
        <div id="userInfo" style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <p id="userEmail" style="font-size: 1.1rem; font-weight: bold;">Loading...</p>
        </div>

        <h3 style="border-bottom: 2px solid #C5A065; padding-bottom: 10px; display:inline-block;">Your Heritage Achievements</h3>
        
        <div id="badgesList" class="badges-container">
            <p>Loading achievements...</p>
        </div>

        <div style="margin-top:40px;">
            <button id="signOutBtn" class="submit-btn">Sign Out</button>
        </div>
    </main>

    <script type="module">
        // 1. UPDATE IMPORT: Get 'realtimeDb' instead of 'db'
        import { auth, realtimeDb } from './firebase-init.js'; 
        
        import { signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { ref, get, child } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

        const userEmail = document.getElementById('userEmail');
        const badgesList = document.getElementById('badgesList');
        const signOutBtn = document.getElementById('signOutBtn');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userEmail.textContent = 'Welcome back, ' + user.email;

                // 2. USE 'realtimeDb' HERE
                const dbRef = ref(realtimeDb); 
                
                try {
                    // This matches your screenshot structure: users -> UID -> Toast/Kopi
                    const snapshot = await get(child(dbRef, `users/${user.uid}`));
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        renderBadges(data);
                    } else {
                        badgesList.innerHTML = "<p>No game data found. Start playing to earn badges!</p>";
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                    badgesList.innerHTML = "<p>Error loading badges.</p>";
                }
            } else {
                window.location.href = 'index.html';
            }
        });


        // Function to create the Badge HTML
        function renderBadges(data) {
            badgesList.innerHTML = ""; // Clear loading text

            // --- BADGE 1: KOPI ---
            if (data.Kopi === true) {
                badgesList.innerHTML += `
                    <div class="badge-card">
                        <span class="badge-icon">‚òï</span>
                        <div class="badge-title">Nanyang Brewmaster</div>
                        <div class="badge-desc">You've mastered the art of the perfect pour.</div>
                    </div>
                `;
            }

            // --- BADGE 2: TOAST ---
            if (data.Toast === true) {
                badgesList.innerHTML += `
                    <div class="badge-card">
                        <span class="badge-icon">üçû</span>
                        <div class="badge-title">Charcoal Grill Guardian</div>
                        <div class="badge-desc">You kept the heritage flame alive.</div>
                    </div>
                `;
            }

            // If no badges yet
            if (!data.Kopi && !data.Toast) {
                badgesList.innerHTML = "<p>You haven't earned any badges yet. Open the app to start your journey!</p>";
            }
        }

        // Sign Out Logic
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Sign out error', err);
            }
        });
    </script>
</body>
</html>
