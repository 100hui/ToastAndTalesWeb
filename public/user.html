<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Profile - Toast & Tales</title>
    <link rel="stylesheet" href="homepage.css">
    <style>

        .badges-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge-card {
            background: white;
            border: 2px solid var(--yakun-brown);
            border-radius: 10px;
            padding: 20px;
            width: 200px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .badge-card:hover {
            transform: scale(1.05);
        }

        .badge-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .badge-title {
            color: var(--yakun-red);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-desc {
            font-size: 0.8rem;
            color: #666;
            min-height: 40px; 
        }

        /*Style for the Time Display */
        .badge-time {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--yakun-brown);
        }

        /* LOCKED STATE */
        .locked {
            opacity: 0.6;
            filter: grayscale(100%);
            background-color: #f0f0f0;
            border-color: #ccc;
        }
        
        .locked .badge-title {
            color: #555;
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">Toast & Tales</div>
        <div class="nav-links">
            <a href="index.html" class="nav-btn">Home</a>
        </div>
    </nav>

    <main style="max-width:800px;margin:40px auto;padding:20px;">
        <h2>Your Profile</h2>
        
        <div id="userInfo" style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <p id="userEmail" style="font-size: 1.1rem; font-weight: bold;">Loading...</p>
        </div>

        <h3 style="border-bottom: 2px solid #C5A065; padding-bottom: 10px; display:inline-block;">Your Heritage Achievements</h3>
        
        <div id="badgesList" class="badges-container">
            <p>Loading achievements...</p>
        </div>

        <div style="margin-top:40px; text-align: center;">
            <button id="signOutBtn" class="submit-btn" style="width: 200px;">Sign Out</button>
        </div>
    </main>

    <script type="module">
        import { auth, realtimeDb } from './firebase-init.js'; 
        import { signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { ref, get, child } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

        const userEmail = document.getElementById('userEmail');
        const badgesList = document.getElementById('badgesList');
        const signOutBtn = document.getElementById('signOutBtn');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userEmail.textContent = 'Welcome back, ' + user.email;

                const dbRef = ref(realtimeDb); 
                
                try {
                    const snapshot = await get(child(dbRef, `users/${user.uid}`));
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        renderBadges(data);
                    } else {
                        renderBadges({}); 
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                    badgesList.innerHTML = "<p>Error loading badges.</p>";
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function renderBadges(data) {
            badgesList.innerHTML = ""; // Clear loading text

            // --- 1. KOPI BADGE ---
            // Updated Logic: Check if 'completed' is true inside the object
            const hasKopi = data.Kopi && data.Kopi.completed === true;
            // Get Time: If it exists, round to 2 decimals, otherwise show --
            const kopiTime = hasKopi && data.Kopi.timeTaken ? parseFloat(data.Kopi.timeTaken).toFixed(2) + "s" : null;

            badgesList.innerHTML += `
                <div class="badge-card ${hasKopi ? '' : 'locked'}">
                    <span class="badge-icon">‚òï</span>
                    <div class="badge-title">${hasKopi ? 'Nanyang Brewmaster' : 'Locked'}</div>
                    <div class="badge-desc">${hasKopi ? "You've mastered the art of the perfect pour." : "Complete the Kopi brewing level to unlock."}</div>
                    ${hasKopi ? `<div class="badge-time">‚è± Time Taken: ${kopiTime}</div>` : ''}
                </div>
            `;

            // --- 2. TOAST BADGE ---
            const hasToast = data.Toast && data.Toast.completed === true;
            const toastTime = hasToast && data.Toast.timeTaken ? parseFloat(data.Toast.timeTaken).toFixed(2) + "s" : null;

            badgesList.innerHTML += `
                <div class="badge-card ${hasToast ? '' : 'locked'}">
                    <span class="badge-icon">üçû</span>
                    <div class="badge-title">${hasToast ? 'Charcoal Grill Guardian' : 'Locked'}</div>
                    <div class="badge-desc">${hasToast ? "You kept the heritage flame alive." : "Complete the Toast grilling level to unlock."}</div>
                    ${hasToast ? `<div class="badge-time">‚è± Time Taken: ${toastTime}</div>` : ''}
                </div>
            `;

            // --- 3. FULL SET BADGE ---
            // Logic: Check progress OR if TraySet is completed
            const hasFullSet = (data.progress >= 3) || (data.TraySet && data.TraySet.completed === true);
            // Get Time for Full Set
            const setTime = (data.TraySet && data.TraySet.timeTaken) ? parseFloat(data.TraySet.timeTaken).toFixed(2) + "s" : null;

            badgesList.innerHTML += `
                <div class="badge-card ${hasFullSet ? '' : 'locked'}">
                    <span class="badge-icon">üèÜ</span>
                    <div class="badge-title">${hasFullSet ? 'The Heritage Legend' : 'Locked'}</div>
                    <div class="badge-desc">${hasFullSet ? "You assembled the ultimate traditional breakfast!" : "Complete all 3 dishes to unlock the final badge."}</div>
                    ${hasFullSet && setTime ? `<div class="badge-time">‚è± Time Taken: ${setTime}</div>` : ''}
                </div>
            `;
        }

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Sign out error', err);
            }
        });
    </script>
</body>
</html>